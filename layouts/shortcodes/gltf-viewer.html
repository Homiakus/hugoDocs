{{/* GLTF Viewer Shortcode */}}
{{/* Usage: {{< gltf-viewer url="/path/to/model.gltf" title="Model Title" >}} */}}

<div class="gltf-viewer-container" style="width: 100%; height: 400px; margin: 1rem 0; border: 1px solid #ddd; border-radius: 8px; overflow: hidden;">
    <div class="gltf-viewer-header" style="background: #f5f5f5; padding: 0.5rem 1rem; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center;">
        <h4 style="margin: 0; font-size: 1rem;">{{ .Get "title" | default "3D Model" }}</h4>
        <div class="gltf-controls">
            <button class="gltf-reset" style="background: #007bff; color: white; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">Reset View</button>
        </div>
    </div>
    <div id="gltf-canvas-{{ .Ordinal }}" class="gltf-canvas" style="width: 100%; height: 350px;"></div>
</div>

<script type="module">
// Import Three.js from CDN
import * as THREE from 'https://cdn.skypack.dev/three@0.150.1';
import { GLTFLoader } from 'https://cdn.skypack.dev/three@0.150.1/examples/jsm/loaders/GLTFLoader.js';
import { OrbitControls } from 'https://cdn.skypack.dev/three@0.150.1/examples/jsm/controls/OrbitControls.js';

(function() {
    const canvasId = 'gltf-canvas-{{ .Ordinal }}';
    const modelUrl = '{{ .Get "url" }}';
    const container = document.getElementById(canvasId);
    
    if (!container) return;
    
    // Scene setup
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0xf0f0f0);
    
    // Camera setup
    const camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
    camera.position.set(0, 0, 5);
    
    // Renderer setup
    const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    renderer.setSize(container.clientWidth, container.clientHeight);
    renderer.setPixelRatio(window.devicePixelRatio);
    renderer.shadowMap.enabled = true;
    renderer.shadowMap.type = THREE.PCFSoftShadowMap;
    container.appendChild(renderer.domElement);
    
    // Lighting
    const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
    scene.add(ambientLight);
    
    const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
    directionalLight.position.set(10, 10, 5);
    directionalLight.castShadow = true;
    scene.add(directionalLight);
    
    // Controls
    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 0.05;
    controls.screenSpacePanning = false;
    controls.minDistance = 1;
    controls.maxDistance = 50;
    
    // Load GLTF model
    const loader = new GLTFLoader();
    let model;
    
    loader.load(
        modelUrl,
        function (gltf) {
            model = gltf.scene;
            
            // Center and scale model
            const box = new THREE.Box3().setFromObject(model);
            const center = box.getCenter(new THREE.Vector3());
            const size = box.getSize(new THREE.Vector3());
            
            const maxDim = Math.max(size.x, size.y, size.z);
            const scale = 2 / maxDim;
            model.scale.setScalar(scale);
            
            model.position.sub(center.multiplyScalar(scale));
            
            // Enable shadows for all meshes
            model.traverse((child) => {
                if (child.isMesh) {
                    child.castShadow = true;
                    child.receiveShadow = true;
                }
            });
            
            scene.add(model);
            
            // Auto-rotate for better presentation
            controls.autoRotate = true;
            controls.autoRotateSpeed = 1.0;
        },
        function (xhr) {
            console.log((xhr.loaded / xhr.total * 100) + '% loaded');
        },
        function (error) {
            console.error('An error occurred loading the GLTF model:', error);
            container.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #666;">Error loading 3D model</div>';
        }
    );
    
    // Reset view button
    const resetButton = container.parentElement.querySelector('.gltf-reset');
    if (resetButton) {
        resetButton.addEventListener('click', function() {
            if (model) {
                controls.reset();
                camera.position.set(0, 0, 5);
                controls.update();
            }
        });
    }
    
    // Animation loop
    function animate() {
        requestAnimationFrame(animate);
        controls.update();
        renderer.render(scene, camera);
    }
    animate();
    
    // Handle window resize
    function onWindowResize() {
        camera.aspect = container.clientWidth / container.clientHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(container.clientWidth, container.clientHeight);
    }
    
    window.addEventListener('resize', onWindowResize);
    
    // Initial resize
    onWindowResize();
})();
</script>